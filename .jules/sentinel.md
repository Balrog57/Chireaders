## 2025-06-03 - [Race Condition in AsyncStorage Background Tasks]
**Vulnerability:** A "Check-Then-Act" race condition was found in `BackgroundNotificationTask.js`. The task read data from `AsyncStorage`, performed long-running network operations, and then overwrote the storage with the stale initial data plus updates. This caused user changes (e.g., deleting a favorite) made during the task execution to be lost.
**Learning:** Background tasks in React Native headless JS operate independently of the UI state and contexts. Direct `AsyncStorage` usage without re-validation is dangerous for data integrity when user interaction is possible concurrently.
**Prevention:** Always implement a "Fetch-Merge-Save" strategy for background tasks: collect updates first, then re-read the storage source of truth immediately before saving, merging the updates into the fresh state.
## 2025-06-03 - [WebView Message Handling Origin Validation]
**Vulnerability:** The `onMessage` handler in `BrowserScreen.js` processed incoming messages from the WebView without verifying the origin URL. An attacker who managed to load a malicious page in the WebView could send spoofed messages (e.g., modifying state, extracting data if the handler exposed it) mimicking legitimate application messages.
**Learning:** `WebView` `onMessage` events can be triggered by any code running within the webview's context. Always treat the message payload as untrusted input and explicitly validate the `event.nativeEvent.url` to ensure the message originated from a trusted domain before parsing or acting upon its contents.
**Prevention:** Enforce strict URL origin checks (using tools like `isValidChiReadsUrl`) at the very beginning of any WebView `onMessage` handler.
